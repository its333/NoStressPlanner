// .husky/pre-commit
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run linting and formatting checks
echo "ğŸ” Running pre-commit checks..."

# Check if files are staged
if [ -z "$(git diff --cached --name-only)" ]; then
  echo "No staged files found"
  exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -z "$STAGED_FILES" ]; then
  echo "No TypeScript/JavaScript files staged"
  exit 0
fi

echo "ğŸ“ Staged files:"
echo "$STAGED_FILES"

# Run Prettier on staged files
echo "ğŸ¨ Running Prettier..."
echo "$STAGED_FILES" | xargs npx prettier --write

# Run ESLint on staged files
echo "ğŸ”§ Running ESLint..."
echo "$STAGED_FILES" | xargs npx eslint --fix

# Re-stage files after formatting
echo "ğŸ“¦ Re-staging formatted files..."
echo "$STAGED_FILES" | xargs git add

# Run type checking
echo "ğŸ” Running TypeScript type check..."
npx tsc --noEmit

# Run tests for staged files (if any test files are staged)
TEST_FILES=$(echo "$STAGED_FILES" | grep -E '\.(test|spec)\.(ts|tsx)$')
if [ ! -z "$TEST_FILES" ]; then
  echo "ğŸ§ª Running tests for staged test files..."
  npx vitest run
fi

echo "âœ… Pre-commit checks passed!"
